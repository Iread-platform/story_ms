stages:
  - build
  - publish
  - dockerize
  - deploy


variables:
  DOCKER_USER_NAME: "yazankassamcodavia"
  DOCKER_PASSWORD: "yazankassamcod@v!@"
  DOCKER_ORGANIZATION_NAME: "iread"
  DOCKER_IMAGE_NAME: "story_ms"
  CONTAINER_PORT: "5010"


deploy:
  stage: deploy
  image: alpine
  only:
    - develop
    - master
  before_script:
    - apk add openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:

    - echo image name = ${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME}:0.6.8
    - echo container name = ${DOCKER_IMAGE_NAME}
    - ssh -o StrictHostKeyChecking=no root@46.227.254.20 "docker images --format {{.Repository}}:{{.Tag}}"
    - ssh -o StrictHostKeyChecking=no root@46.227.254.20 "docker ps --format {{.Names}}"
    
    ## STOP CURRENT CNTAINER IF EXISTS
    - ssh -o StrictHostKeyChecking=no root@46.227.254.20 "docker ps -q --filter ancestor=${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME}:0.6.8 | grep -q . && docker stop ${DOCKER_IMAGE_NAME} || echo Not Found Running Container With Name = ${DOCKER_IMAGE_NAME} ;"

    ## REMOVE CURRENT CNTAINER IF EXISTS
    - ssh -o StrictHostKeyChecking=no root@46.227.254.20 "docker ps -q -a --filter ancestor=${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME}:0.6.8 | grep -q . && docker rm -fv ${DOCKER_IMAGE_NAME} || echo Not Found Stopped Container With Name = ${DOCKER_IMAGE_NAME} ;"

    ## REMOVE CURRENT VERSION OF IMAGE IF EXISTS
    - ssh -o StrictHostKeyChecking=no root@46.227.254.20 "docker images -q --filter reference=${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME}:0.6.8 | grep -q . && docker rmi $(docker images ${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME}:0.6.8 -a -q) || echo Not Found Image With Name = ${DOCKER_IMAGE_NAME} ;"




