stages:
  - deploy


variables:
  DOCKER_USER_NAME: "yazankassamcodavia"
  DOCKER_PASSWORD: "yazankassamcod@v!@"
  DOCKER_ORGANIZATION_NAME: "iread"
  DOCKER_IMAGE_NAME: "story_ms"
  CONTAINER_PORT: "5010"


deploy:
  stage: deploy
  image: alpine
  only:
    - develop
    - master
  before_script:
    - apk add openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    
    - echo image name = ${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME}:0.6.8
    - echo container name = ${DOCKER_IMAGE_NAME}
    - ssh -o StrictHostKeyChecking=no root@46.227.254.20 " echo ======== docker images ========; docker images --format {{.Repository}}:{{.Tag}}; echo ======== docker containers ========; docker ps --format {{.Names}}; echo ======== last docker images of this micro service ========; docker images -q --filter reference=${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME}; "
    

    ## REMOVE CURRENT VERSION OF IMAGE IF EXISTS
    - ssh -o StrictHostKeyChecking=no root@46.227.254.20 'docker images -q --filter reference=${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME} | grep -q -a . && docker rmi $(docker images --format="{{.Repository}} {{.ID}}" |  grep "^${DOCKER_ORGANIZATION_NAME}/${DOCKER_IMAGE_NAME} " |  cut -d" " -f2 | tr "\r\n" " ") || echo Not Found Image With Name = ${DOCKER_IMAGE_NAME};'

